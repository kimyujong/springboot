name: Deploy Spring Boot

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì¹˜ (í”„ë¡œì íŠ¸ ìë°” ë²„ì „ì— ë§ì¶¤)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 4. ë¹Œë“œëœ JAR íŒŒì¼ì„ EC2ë¡œ ì „ì†¡
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/home/ubuntu/springboot"
          rm: true
          # strip_components: 2 # í•„ìš” ì‹œ ê²½ë¡œ ì œê±° ì˜µì…˜ (build/libs í´ë” ì—†ì´ jarë§Œ ë„£ê³  ì‹¶ì„ ë•Œ)

      # 5. EC2 ì ‘ì†í•´ì„œ ì¬ì‹œì‘
      - name: Restart Spring Boot
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘: Spring Boot"
            
            # 1. PM2ë¡œ Spring Boot ì¬ì‹œì‘ (ecosystem.config.js ì„¤ì •ëŒ€ë¡œ)
            # ë§Œì•½ ìƒˆ JAR íŒŒì¼ì´ build/libs í´ë” ì•ˆì— ë“¤ì–´ê°”ë‹¤ë©´ ê²½ë¡œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë¨
            
            pm2 restart springboot-server
            
            echo "âœ… Spring Boot ë°°í¬ ì™„ë£Œ!"
